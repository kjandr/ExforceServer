### 1) Login – Token holen
POST http://localhost:50837/api/v2/user/login
Content-Type: application/json

{
  "email": "test@test.com",
  "password": "123",
  "cpu_id": "0987654321"
}

> {%
    client.test("Login 200", () => client.assert(response.status === 200, "Status " + response.status));
    const tok = response.body?.token ?? response.body?.data?.token ?? "";
    client.test("Token da", () => client.assert(!!tok, "Kein Token"));
    client.global.set("access_token", tok);

    // Controller-Typ zentral konfigurieren (entspricht dem Beispiel „x1000“)
    client.global.set("controller_type", "X1");   // ggf. auf „X1“ ändern
%}

### 2) CHECK – Infos einsammeln (nur zum Ableiten der URLs/Versionen)
GET http://localhost:50837/api/v2/update/check?type={{controller_type}}&controller=0.0.0.0&pc=0.0.0&gateway=0.0.0&beta=true
Authorization: Bearer {{access_token}}
Accept: application/json

> {%
    client.test("CHECK 200", () => client.assert(response.status === 200, "Status " + response.status));

    const body = response.body || {};
    const type = client.global.get("controller_type");
    const ctrl = body?.controller?.[type] || {};
    const pc   = body?.pc || {};
    const gw   = body?.gateway || {};

    // ---- URLs gemäß BEISPIEL-AUFRUFEN vorbereiten ----
    // 1) Controller Release – neueste (ohne version, nur component=controller&type=...)
    const ctrlReleaseUrl = `http://localhost:50837/api/v2/update/download?component=controller&type=${encodeURIComponent(type)}`;

    // 2) Controller Beta – neueste (nur wenn Beta existiert; sonst fallback auf Release)
    const hasBeta = !!ctrl?.beta;
    const ctrlBetaUrl = hasBeta
        ? `http://localhost:50837/api/v2/update/download?component=controller&type=${encodeURIComponent(type)}&beta=true`
        : ctrlReleaseUrl;

    // 3) PC bestimmte Version – nimm die im CHECK gemeldete Release-Version
    const pcVersion = String(pc?.version || "").trim();
    client.test("PC-Version vorhanden", () => client.assert(!!pcVersion, "Keine PC-Version im CHECK"));
    const pcUrl = `http://localhost:50837/api/v2/update/download?component=pc&version=${encodeURIComponent(pcVersion)}`;

    // 4) Gateway – serverseitiges Streaming (redirect=false), ohne Versionsangabe → latest
    const gwUrl = `http://localhost:50837/api/v2/update/download?component=gateway&redirect=false`;

    // Globale Variablen setzen
    client.global.set("dl_controller_release", ctrlReleaseUrl);
    client.global.set("dl_controller_beta",    ctrlBetaUrl);
    client.global.set("dl_pc",                 pcUrl);
    client.global.set("dl_gateway_stream",     gwUrl);

    // Info für die Ausgabe
    client.log("Controller Release URL: " + ctrlReleaseUrl);
    client.log("Controller Beta URL:    " + ctrlBetaUrl + (hasBeta ? "" : "  (Fallback auf Release, da keine Beta im CHECK)"));
    client.log("PC URL:                 " + pcUrl);
    client.log("Gateway URL:            " + gwUrl);
%}

### 3) DOWNLOAD – Controller (Release, neueste)
GET {{dl_controller_release}}
Authorization: Bearer {{access_token}}
Accept: application/octet-stream

> {%
    client.test("Controller Release Download ok", () =>
        client.assert([200,206].includes(response.status),
            "Download fehlgeschlagen: Status " + response.status + "  URL=" + client.global.get("dl_controller_release")));
%}

### 4) DOWNLOAD – Controller (Beta, neueste – nur Admin; sonst Fallback)
GET {{dl_controller_beta}}
Authorization: Bearer {{access_token}}
Accept: application/octet-stream

> {%
    client.test("Controller Beta/Release Download ok", () =>
        client.assert([200,206].includes(response.status),
            "Download fehlgeschlagen: Status " + response.status + "  URL=" + client.global.get("dl_controller_beta")));
%}

### 5) DOWNLOAD – PC (explizite Version aus CHECK)
GET {{dl_pc}}
Authorization: Bearer {{access_token}}
Accept: application/octet-stream

> {%
    client.test("PC Download ok", () =>
        client.assert([200,206].includes(response.status),
            "Download fehlgeschlagen: Status " + response.status + "  URL=" + client.global.get("dl_pc")));
%}

### 6) DOWNLOAD – Gateway (streaming via redirect=false, neueste)
GET {{dl_gateway_stream}}
Authorization: Bearer {{access_token}}
Accept: application/octet-stream

> {%
    client.test("Gateway Download ok", () =>
        client.assert([200,206].includes(response.status),
            "Download fehlgeschlagen: Status " + response.status + "  URL=" + client.global.get("dl_gateway_stream")));
%}




















### Registrierung (POST)
# curl -X POST http://localhost:8000/user/register -H "Content-Type: application/json" -d '{"email": "test@test.com", "password": "123", "cpu_id": "0987654321"}'
POST http://localhost:50837/api/v2/user/register
Content-Type: application/json

{"email": "test@test.com", "password": "123", "cpu_id": "0987654321"}




### Login (POST)
# curl -X POST http://localhost:8000/user/login -H "Content-Type: application/json" -d '{"email": "test@test.com", "password": "123", "cpu_id": "0987654321"}'
POST http://localhost:50837/api/v2/user/login
Content-Type: application/json

{"email": "test@test.com", "password": "123", "cpu_id": "0987654321"}

> {%
    client.global.set("access_token", response.body.token);
%}



### Login (POST) fail
# curl -X POST http://localhost:8000/user/login -H "Content-Type: application/json" -d '{"email": "test@test.com", "password": "123", "cpu_id": "0987654321"}'
POST http://localhost:50837/api/v2/user/login
Content-Type: application/json

{"email": "test@test.com", "password": "122", "cpu_id": "0987654321"}

> {%
    client.global.set("access_token", response.body.token);
%}


### Controller in die Datenbank einfügen
# curl -X POST "http://localhost:8000/admin/controller/add" -H "Content-Type: application/json" -H "Accept: application/json" -d '{"serial_no": "SN1234567890","remark": "Test_Eintrag","user_id": 1,"type": "Controller_Type_A","uuid": "12345A","battery_cutoff_end": 3.7,"battery_cutoff_start": 4.2,"battery_cells": 6,"battery_ah": 2.4,"battery_current_max": 20,"battery_current_min": 2,"operating_time": 120}
POST http://localhost:50837/admin/controller/add
Authorization: Bearer {{access_token}}
Content-Type: application/json

{"serial_no": "SN1234567890", "remark": "Test_Eintrag", "user_id": -1, "type": "EX8-560", "uuid": "12345A",
  "battery_cutoff_end": 3.7, "battery_cutoff_start": 4.2, "battery_cells": 6, "battery_ah": 2.4, "battery_current_max": 20,
  "battery_current_min": 2, "operating_time": 0}



### Motor in die Datenbank einfügen

# curl -X POST
#  http://localhost:8000/admin/engine/add
#  -H "Content-Type: application/json"
#  -H "Authorization: Bearer IHR_JWT_TOKEN_HIER"
#  -d '{
#    "serial_no": "E12345678",
#    "remark": "Neuer Testmotor",
#    "controller_id": "1",
#    "type": "BLDC",
#    "current_ki": "0.05",
#    "current_kp": "0.03",
#    "freq_foc_khz": "20",
#    "flux_linkage_mwb": "15.2",
#    "inductance_uh": "14",
#    "resistance_mr": "20",
#    "observer_gain": "0.8",
#    "current_max": "35",
#    "erpm_max": "20000",
#    "wattage_max": "750",
#    "temp_type": "NTC",
#    "temp_cutoff_end": "85",
#    "temp_cutoff_start": "75",
#    "mileage_km": "0",
#    "operating_time": "0"
#  }'
POST http://localhost:50837/admin/engine/add
Authorization: Bearer {{access_token}}
Content-Type: application/json

{
  "serial_no": "E12345678",
  "remark": "Neuer Testmotor",
  "controller_id": "1",
  "type": "G510.1000",
  "current_ki": "0.05",
  "current_kp": "0.03",
  "freq_foc_khz": "20",
  "flux_linkage_mwb": "15.2",
  "inductance_uh": "14",
  "resistance_mr": "20",
  "observer_gain": "0.8",
  "current_max": "35",
  "erpm_max": "20000",
  "wattage_max": "750",
  "temp_type": "NTC",
  "temp_cutoff_end": "85",
  "temp_cutoff_start": "75",
  "mileage_km": "0",
  "operating_time": "0"
}

###




### Geschützte Route (GET mit Token)
# curl -X GET http://localhost:8000/test/?uuid=12345A -H "Authorization: Bearer <DEIN-TOKEN>"
GET http://localhost:50837/test/?uuid=12345A
Authorization: Bearer {{access_token}}


### Firmware Check EX8-620
# curl -X GET http://localhost:8000/api/v2/firmware/check?version=1.3.0&12345A&type=EX8-620 -H "Authorization: Bearer <DEIN-TOKEN>"
GET http://localhost:50837/api/v2/update/check?type=EX8-560&controller=1.0.0.0&pc=2.0.0.0&mobile=1.5.0.0&gateway=1.0.0.0&beta=true
Authorization: Bearer {{access_token}}

### Firmware Check EX8-620
#
GET http://localhost:50837/api/v2/update/check?type=EX8-560&controller=4.0.0.8&beta=true
Authorization: Bearer {{access_token}}

### Firmware Check EX8-560
# curl -X GET http://localhost:8000/api/v2/firmware/check?version=1.2.0&12345A&type=EX8-560 -H "Authorization: Bearer <DEIN-TOKEN>"
GET http://localhost:50837/api/v2/update/check?version=1.2.0&12345A&type=EX8-560
Authorization: Bearer {{access_token}}

### Firmware Check EX8-560 kein UPDATE
# curl -X GET http://localhost:8000/api/v2/firmware/check?version=1.3.0&12345A&type=EX8-560 -H "Authorization: Bearer <DEIN-TOKEN>"
GET http://localhost:50837/api/v2/update/check?version=1.3.0&12345A&type=EX8-560
Authorization: Bearer {{access_token}}

### Firmware Check EX8-560 kein DEVICE
# curl -X GET http://localhost:8000/api/v2/firmware/check?version=1.3.0&12345A&type=EX8-111 -H "Authorization: Bearer <DEIN-TOKEN>"
GET http://localhost:50837/api/v2/update/check?version=1.3.0&12345A&type=EX8-111
Authorization: Bearer {{access_token}}


###
# curl -X POST http://localhost:8000/user/request-password-reset -H "Content-Type: application/json" -d '{"email": "test@test.com"}'
POST http://localhost:50837/api/v2/user/request-password-reset
Content-Type: application/json

{"email": "test@test.com"}
